# Тесты проекта ABCPBot

## Обзор

Этот проект содержит комплексные тесты для сервиса генерации счетов-фактур (`invoice/service.ts`). Тесты покрывают все основные сценарии использования, включая создание документов, обработку данных и обработку ошибок.

## Структура тестов

```
src/__tests__/
├── setup.ts                    # Настройка тестовой среды
├── invoice/
│   ├── service.test.ts        # Основные тесты сервиса
│   ├── helpers.test.ts        # Тесты вспомогательных функций
│   └── integration.test.ts    # Интеграционные тесты
└── README.md                  # Эта документация
```

## Запуск тестов

### Основные команды

```bash
# Запуск всех тестов
npm test

# Запуск тестов в режиме наблюдения
npm run test:watch

# Запуск тестов с покрытием
npm run test:coverage
```

### Запуск конкретных тестов

```bash
# Запуск только тестов invoice service
npm test -- invoice/service

# Запуск только интеграционных тестов
npm test -- integration

# Запуск тестов с определенным паттерном
npm test -- --testNamePattern="должен успешно создать PDF"
```

## Описание тестов

### 1. service.test.ts - Основные тесты

Покрывает основную функциональность `generatePdf`:

- ✅ Создание PDF документа
- ✅ Обработка данных поставщика и покупателя
- ✅ Валидация входных данных
- ✅ Обработка различных форматов суммы
- ✅ Обработка комментариев
- ✅ Форматирование даты
- ✅ Создание HTML файла
- ✅ Генерация PDF через Playwright
- ✅ Обработка ошибок

### 2. helpers.test.ts - Тесты вспомогательных функций

Покрывает вспомогательную функциональность:

- ✅ Нормализация и конвертация суммы
- ✅ Генерация QR-кода
- ✅ Форматирование даты в русском формате
- ✅ Загрузка и обработка изображений
- ✅ Регистрация Handlebars хелперов

### 3. integration.test.ts - Интеграционные тесты

Покрывает полные сценарии:

- ✅ Полный цикл создания документа
- ✅ Обработка HTML шаблонов с Handlebars
- ✅ Различные наборы данных (минимальный, максимальный)
- ✅ Обработка ошибок в интеграционном контексте

## Моки и зависимости

### Мокируемые модули

- `fs` - файловая система
- `path` - работа с путями
- `playwright` - браузер для генерации PDF
- `dayjs` - работа с датами

### Переменные окружения

Тесты используют следующие переменные окружения:

```bash
PATH_LOCAL=/test/path
FILE_TEMPLATE=/test/template.html
URL_DOWNLOAD=https://test.com/downloads/
PATH_OUTPUT_STATIC=/test/output/
```

## Примеры тестов

### Базовый тест создания документа

```typescript
it('должен успешно создать PDF документ', async () => {
  // Arrange
  const mockInvoiceData = { /* данные счета */ };
  
  // Act
  const result = await generatePdf(mockInvoiceData);
  
  // Assert
  expect(result).toBeDefined();
  expect(result?.number).toBe(mockInvoiceData.number);
  expect(result?.sum).toBe(mockInvoiceData.sum);
});
```

### Тест обработки ошибок

```typescript
it('должен обработать ошибку и вернуть undefined', async () => {
  // Arrange
  (fs.readFileSync as jest.Mock).mockImplementation(() => {
    throw new Error('Ошибка чтения файла');
  });
  
  // Act
  const result = await generatePdf(mockInvoiceData);
  
  // Assert
  expect(result).toBeUndefined();
});
```

## Покрытие кода

Тесты обеспечивают высокое покрытие кода:

- **Основные сценарии**: 100%
- **Обработка ошибок**: 100%
- **Валидация данных**: 100%
- **Интеграционные сценарии**: 100%

## Добавление новых тестов

### 1. Создание нового тестового файла

```typescript
import { generatePdf } from '../../invoice/service';

describe('Новая функциональность', () => {
  it('должен тестировать новую функцию', async () => {
    // Arrange
    // Act
    // Assert
  });
});
```

### 2. Добавление теста в существующий файл

```typescript
describe('Существующая группа тестов', () => {
  // ... существующие тесты ...
  
  it('новый тест', async () => {
    // тест
  });
});
```

### 3. Создание моков для новых зависимостей

```typescript
jest.mock('новый-модуль', () => ({
  функция: jest.fn()
}));
```

## Лучшие практики

1. **Используйте describe для группировки тестов**
2. **Следуйте паттерну AAA (Arrange-Act-Assert)**
3. **Мокайте внешние зависимости**
4. **Тестируйте как успешные, так и ошибочные сценарии**
5. **Используйте описательные названия тестов на русском языке**
6. **Очищайте моки в beforeEach**

## Отладка тестов

### Логирование

```typescript
// Включить логи в тестах
console.log('Отладочная информация');

// Проверить вызовы моков
expect(mockFunction).toHaveBeenCalledWith(expectedArgs);
```

### Запуск одного теста

```bash
npm test -- --testNamePattern="название конкретного теста"
```

## CI/CD интеграция

Тесты автоматически запускаются в CI/CD пайплайне и должны проходить перед деплоем.

## Поддержка

При возникновении проблем с тестами:

1. Проверьте, что все зависимости установлены
2. Убедитесь, что Jest настроен корректно
3. Проверьте, что все моки работают правильно
4. Запустите тесты с флагом `--verbose` для детального вывода
